<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>utubee</title>
  <style>
    body{margin:0;background:#0b0b0f;color:#e9e9ee;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:14px 16px 40px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .card{border:1px solid rgba(255,255,255,.1);border-radius:16px;overflow:hidden;background:rgba(255,255,255,.04)}
    .tile{position:relative;aspect-ratio:16/9;background:#111}
    .tile img{width:100%;height:100%;object-fit:cover;display:block;cursor:pointer}
    .play{position:absolute;inset:0;display:grid;place-items:center;cursor:pointer;
          background:linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,.05))}
    .play span{width:56px;height:56px;border-radius:999px;display:grid;place-items:center;
               background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.22)}
    .play svg{width:18px;height:18px;fill:#fff;margin-left:2px}
    .player{width:100%;height:100%;border:0;display:block}
    .x{
      position:absolute; top:8px; right:8px; z-index:3;
      padding:6px 9px; border-radius:12px;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.16);
      color:#fff; cursor:pointer; user-select:none;
      font-size:12px; line-height:1;
    }
    .status{opacity:.8;font-size:12px;padding:12px 2px}
  </style>
</head>
<body>
<div class="wrap">
  <div id="grid" class="grid"></div>
  <div id="status" class="status"></div>
</div>

<script>
  function parseVideoId(input){
    const s = String(input||"").trim();
    if(!s) return null;
    if(/^[a-zA-Z0-9_-]{8,15}$/.test(s) && !s.includes("http")) return s;
    try{
      const u = new URL(s);
      if(u.hostname.includes("youtu.be")) return u.pathname.replace("/","") || null;
      if(u.hostname.includes("youtube.com")){
        if(u.searchParams.get("v")) return u.searchParams.get("v");
        const m = u.pathname.match(/\/shorts\/([^/]+)/); if(m) return m[1];
        const e = u.pathname.match(/\/embed\/([^/]+)/); if(e) return e[1];
      }
    }catch{}
    return null;
  }

  const grid = document.getElementById("grid");
  const statusEl = document.getElementById("status");

  function makeThumbHTML(id){
    return `
      <img loading="lazy" src="https://i.ytimg.com/vi/${id}/hqdefault.jpg" alt="">
      <div class="play" aria-hidden="true">
        <span title="Play">
          <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </span>
      </div>
    `;
  }

  function makePlayerHTML(id){
    // autoplay needs a user gesture — your click counts.
    return `
      <div class="x" title="Stop">✕</div>
      <iframe
        class="player"
        src="https://www.youtube-nocookie.com/embed/${id}?autoplay=1&rel=0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen"
        allowfullscreen
        title="YouTube player"></iframe>
    `;
  }

  function setTileToThumb(tile, id){
    tile.dataset.mode = "thumb";
    tile.innerHTML = makeThumbHTML(id);
  }

  function setTileToPlayer(tile, id){
    tile.dataset.mode = "player";
    tile.innerHTML = makePlayerHTML(id);
  }

  async function init(){
    let data;
    try{
      const res = await fetch("./videos.json", {cache:"no-store"});
      data = await res.json();
    }catch(err){
      statusEl.textContent = "Couldn't load videos.json. Create it in the repo root.";
      return;
    }

    const urls = data.videos || [];
    const ids = urls.map(parseVideoId).filter(Boolean);

    statusEl.textContent = ids.length ? "" : "No valid videos in videos.json yet.";
    for(const id of ids){
      const card = document.createElement("div");
      card.className = "card";

      const tile = document.createElement("div");
      tile.className = "tile";
      tile.dataset.id = id;
      setTileToThumb(tile, id);

      // Click handling:
      // - if thumb → switch to player
      // - if player → clicking ✕ stops (switch back to thumb)
      tile.addEventListener("click", (e) => {
        const id = tile.dataset.id;
        const mode = tile.dataset.mode;

        if (mode === "thumb") {
          // Optional: stop any other playing tiles (Netflix-style discipline)
          document.querySelectorAll(".tile[data-mode='player']").forEach(other => {
            if (other !== tile) setTileToThumb(other, other.dataset.id);
          });
          setTileToPlayer(tile, id);
          return;
        }

        // If player mode, only stop when clicking the ✕
        const x = e.target.closest(".x");
        if (x) setTileToThumb(tile, id);
      });

      card.appendChild(tile);
      grid.appendChild(card);
    }
  }

  init();
</script>
</body>
</html>
